<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>3D彩票 - 去中心化彩票系统</title>
    <meta name="description" content="基于CosmWasm的去中心化3D彩票系统" />
    <meta name="keywords" content="彩票,区块链,去中心化,CosmWasm" />
    
    <!-- 强化的CosmJS兼容性修复 -->
    <script>
      (function() {
        console.log('=== 开始CosmJS兼容性修复 ===');
        
        // 最强制的方式确保globalThis存在
        (function() {
          if (typeof globalThis !== 'undefined') return;
          
          // 尝试多种方式设置globalThis
          try {
            (function() { return this; })().globalThis = (function() { return this; })();
          } catch (e) {
            // 如果失败，使用window
            if (typeof window !== 'undefined') {
              window.globalThis = window;
            } else if (typeof self !== 'undefined') {
              self.globalThis = self;
            } else if (typeof global !== 'undefined') {
              global.globalThis = global;
            }
          }
        })();
        
        // 确保global存在
        if (typeof global === 'undefined') {
          if (typeof globalThis !== 'undefined') {
            globalThis.global = globalThis;
          } else if (typeof window !== 'undefined') {
            window.global = window;
          }
        }
        
        // 最终验证
        if (typeof globalThis === 'undefined') {
          console.error('无法设置globalThis，强制使用window');
          window.globalThis = window;
        }
        
        // 创建简单的Web API polyfill
        function createSimplePolyfill() {
          const Request = function(input, init) {
            this.url = input;
            this.method = (init && init.method) || 'GET';
            this.headers = new Headers(init && init.headers);
            this.body = init && init.body;
            this.mode = (init && init.mode) || 'cors';
            this.credentials = (init && init.credentials) || 'same-origin';
            this.cache = (init && init.cache) || 'default';
            this.redirect = (init && init.redirect) || 'follow';
            this.referrer = (init && init.referrer) || 'about:client';
            this.signal = (init && init.signal) || null;
          };
          
          const Response = function(body, init) {
            this.body = body;
            this.status = (init && init.status) || 200;
            this.statusText = (init && init.statusText) || 'OK';
            this.headers = new Headers(init && init.headers);
            this.ok = ((init && init.status) || 200) >= 200 && ((init && init.status) || 200) < 300;
            this.type = 'basic';
            this.url = '';
            this.redirected = false;
          };
          
          const Headers = function(init) {
            this._headers = {};
            if (init) {
              if (Array.isArray(init)) {
                init.forEach(([key, value]) => {
                  this._headers[key.toLowerCase()] = value;
                });
              } else if (typeof init === 'object') {
                Object.keys(init).forEach(key => {
                  this._headers[key.toLowerCase()] = init[key];
                });
              }
            }
          };
          
          Headers.prototype.get = function(name) {
            return this._headers[name.toLowerCase()] || null;
          };
          Headers.prototype.set = function(name, value) {
            this._headers[name.toLowerCase()] = value;
          };
          Headers.prototype.has = function(name) {
            return name.toLowerCase() in this._headers;
          };
          Headers.prototype.delete = function(name) {
            delete this._headers[name.toLowerCase()];
          };
          
          const fetch = function(input, init) {
            return Promise.reject(new Error('fetch not available'));
          };
          
          return { Request, Response, Headers, fetch };
        }
        
        const polyfill = createSimplePolyfill();
        
        // 强制确保globalThis存在
        if (typeof globalThis === 'undefined') {
          // 最后的备用方案
          try {
            (function() { return this; })().globalThis = (function() { return this; })();
          } catch (e) {
            // 如果还是失败，直接设置到window
            window.globalThis = window;
          }
        }
        
        // 验证globalThis确实存在
        if (typeof globalThis === 'undefined') {
          console.error('无法设置globalThis，使用window作为备用');
          window.globalThis = window;
        }
        
        // 直接设置到所有全局对象
        globalThis.Request = polyfill.Request;
        globalThis.Response = polyfill.Response;
        globalThis.Headers = polyfill.Headers;
        globalThis.fetch = polyfill.fetch;
        
        window.Request = polyfill.Request;
        window.Response = polyfill.Response;
        window.Headers = polyfill.Headers;
        window.fetch = polyfill.fetch;
        
        global.Request = polyfill.Request;
        global.Response = polyfill.Response;
        global.Headers = polyfill.Headers;
        global.fetch = polyfill.fetch;
        
        // 额外的保护：确保在模块加载时globalThis可用
        Object.defineProperty(window, 'globalThis', {
          value: globalThis,
          writable: true,
          configurable: true,
          enumerable: false
        });
        
        console.log('=== CosmJS兼容性修复完成 ===');
        console.log('globalThis状态:', {
          exists: typeof globalThis !== 'undefined',
          hasRequest: globalThis && typeof globalThis.Request !== 'undefined',
          hasResponse: globalThis && typeof globalThis.Response !== 'undefined',
          hasHeaders: globalThis && typeof globalThis.Headers !== 'undefined',
          hasFetch: globalThis && typeof globalThis.fetch !== 'undefined'
        });
      })();
    </script>
    
    <script type="module" src="/src/main.tsx"></script>
  </head>
  <body>
    <div id="root"></div>
    
  </body>
</html>