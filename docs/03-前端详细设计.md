# DD 3D 彩票前端 详细设计文档

## 📋 文档信息

- **项目名称**: DD 3D Lottery Frontend (3D彩票前端应用)
- **版本**: v1.0.0
- **文档类型**: 前端详细设计文档
- **创建日期**: 2024-01-XX
- **最后更新**: 2024-01-XX

## 🎯 概述

本文档详细描述了DD 3D Lottery前端应用的实现细节，包括组件设计、API接口、数据模型、状态管理、路由配置等具体实现方案。

## 🏗️ 项目结构

### 1.1 目录结构

```
src/
├── components/          # 可复用组件
│   ├── ui/            # 基础UI组件
│   ├── wallet/        # 钱包相关组件
│   ├── lottery/       # 彩票相关组件
│   └── layout/        # 布局组件
├── pages/             # 页面组件
│   ├── Home/          # 首页
│   ├── Bet/           # 投注页面
│   ├── Reveal/        # 揭秘页面
│   ├── Result/        # 结果页面
│   └── History/       # 历史页面
├── services/          # 服务层
│   ├── wallet/        # 钱包服务
│   ├── contract/      # 合约服务
│   ├── api/          # API服务
│   └── storage/      # 存储服务
├── hooks/            # 自定义Hooks
│   ├── useWallet.ts
│   ├── useContract.ts
│   ├── useLottery.ts
│   └── useTheme.ts
├── stores/           # 状态管理
│   ├── walletStore.ts
│   ├── lotteryStore.ts
│   └── uiStore.ts
├── types/            # 类型定义
│   ├── wallet.ts
│   ├── contract.ts
│   ├── lottery.ts
│   └── common.ts
├── utils/            # 工具函数
│   ├── constants.ts
│   ├── helpers.ts
│   ├── validators.ts
│   └── formatters.ts
├── styles/           # 样式文件
│   ├── globals.css
│   ├── components.css
│   └── pages.css
├── locales/          # 国际化
│   ├── zh.json
│   └── en.json
└── App.tsx           # 应用入口
```

### 1.2 文件命名规范

```yaml
naming_conventions:
  components:
    pattern: "PascalCase"
    example: "WalletConnect.tsx"
    
  pages:
    pattern: "PascalCase"
    example: "BetPage.tsx"
    
  hooks:
    pattern: "camelCase"
    example: "useWallet.ts"
    
  services:
    pattern: "camelCase"
    example: "walletService.ts"
    
  types:
    pattern: "camelCase"
    example: "walletTypes.ts"
    
  utils:
    pattern: "camelCase"
    example: "walletUtils.ts"
```

## 🧩 组件设计

### 2.1 基础UI组件

#### 2.1.1 Button组件

```typescript
// components/ui/Button.tsx
import React from 'react';
import { cva, type VariantProps } from 'class-variance-authority';
import { cn } from '@/utils/helpers';

const buttonVariants = cva(
  "inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:opacity-50 disabled:pointer-events-none ring-offset-background",
  {
    variants: {
      variant: {
        default: "bg-primary text-primary-foreground hover:bg-primary/90",
        destructive: "bg-destructive text-destructive-foreground hover:bg-destructive/90",
        outline: "border border-input hover:bg-accent hover:text-accent-foreground",
        secondary: "bg-secondary text-secondary-foreground hover:bg-secondary/80",
        ghost: "hover:bg-accent hover:text-accent-foreground",
        link: "underline-offset-4 hover:underline text-primary",
      },
      size: {
        default: "h-10 py-2 px-4",
        sm: "h-9 px-3 rounded-md",
        lg: "h-11 px-8 rounded-md",
        icon: "h-10 w-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
);

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean;
  loading?: boolean;
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, asChild = false, loading, children, ...props }, ref) => {
    return (
      <button
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        disabled={loading || props.disabled}
        {...props}
      >
        {loading && (
          <svg className="mr-2 h-4 w-4 animate-spin" viewBox="0 0 24 24">
            <circle
              className="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              strokeWidth="4"
            />
            <path
              className="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            />
          </svg>
        )}
        {children}
      </button>
    );
  }
);

Button.displayName = "Button";

export { Button, buttonVariants };
```

#### 2.1.2 Input组件

```typescript
// components/ui/Input.tsx
import React from 'react';
import { cn } from '@/utils/helpers';

export interface InputProps
  extends React.InputHTMLAttributes<HTMLInputElement> {
  label?: string;
  error?: string;
  helper?: string;
}

const Input = React.forwardRef<HTMLInputElement, InputProps>(
  ({ className, type, label, error, helper, ...props }, ref) => {
    return (
      <div className="space-y-2">
        {label && (
          <label className="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">
            {label}
          </label>
        )}
        <input
          type={type}
          className={cn(
            "flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
            error && "border-destructive focus-visible:ring-destructive",
            className
          )}
          ref={ref}
          {...props}
        />
        {error && (
          <p className="text-sm text-destructive">{error}</p>
        )}
        {helper && !error && (
          <p className="text-sm text-muted-foreground">{helper}</p>
        )}
      </div>
    );
  }
);

Input.displayName = "Input";

export { Input };
```

#### 2.1.3 Card组件

```typescript
// components/ui/Card.tsx
import React from 'react';
import { cn } from '@/utils/helpers';

const Card = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "rounded-lg border bg-card text-card-foreground shadow-sm",
      className
    )}
    {...props}
  />
));
Card.displayName = "Card";

const CardHeader = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex flex-col space-y-1.5 p-6", className)}
    {...props}
  />
));
CardHeader.displayName = "CardHeader";

const CardTitle = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLHeadingElement>
>(({ className, ...props }, ref) => (
  <h3
    ref={ref}
    className={cn(
      "text-2xl font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
));
CardTitle.displayName = "CardTitle";

const CardDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => (
  <p
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
));
CardDescription.displayName = "CardDescription";

const CardContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
));
CardContent.displayName = "CardContent";

const CardFooter = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex items-center p-6 pt-0", className)}
    {...props}
  />
));
CardFooter.displayName = "CardFooter";

export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent };
```

### 2.2 钱包组件

#### 2.2.1 WalletConnect组件

```typescript
// components/wallet/WalletConnect.tsx
import React, { useState } from 'react';
import { Button } from '@/components/ui/Button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/Card';
import { useWallet } from '@/hooks/useWallet';
import { WalletType } from '@/types/wallet';

const WalletConnect: React.FC = () => {
  const { connect, disconnect, connected, address, balance, loading } = useWallet();
  const [selectedWallet, setSelectedWallet] = useState<WalletType | null>(null);

  const handleConnect = async (walletType: WalletType) => {
    setSelectedWallet(walletType);
    try {
      await connect(walletType);
    } catch (error) {
      console.error('Failed to connect wallet:', error);
    } finally {
      setSelectedWallet(null);
    }
  };

  const handleDisconnect = async () => {
    try {
      await disconnect();
    } catch (error) {
      console.error('Failed to disconnect wallet:', error);
    }
  };

  if (connected) {
    return (
      <Card>
        <CardHeader>
          <CardTitle>钱包已连接</CardTitle>
          <CardDescription>您的钱包已成功连接</CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          <div>
            <p className="text-sm font-medium">地址:</p>
            <p className="text-sm text-muted-foreground font-mono">{address}</p>
          </div>
          <div>
            <p className="text-sm font-medium">余额:</p>
            <p className="text-sm text-muted-foreground">{balance} USDC</p>
          </div>
          <Button onClick={handleDisconnect} variant="outline" className="w-full">
            断开连接
          </Button>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle>连接钱包</CardTitle>
        <CardDescription>请选择您的钱包进行连接</CardDescription>
      </CardHeader>
      <CardContent className="space-y-4">
        <Button
          onClick={() => handleConnect(WalletType.KEPLR)}
          disabled={loading}
          className="w-full"
        >
          {selectedWallet === WalletType.KEPLR && loading ? '连接中...' : '连接 Keplr'}
        </Button>
        <Button
          onClick={() => handleConnect(WalletType.COSMOSTATION)}
          disabled={loading}
          variant="outline"
          className="w-full"
        >
          {selectedWallet === WalletType.COSMOSTATION && loading ? '连接中...' : '连接 Cosmostation'}
        </Button>
      </CardContent>
    </Card>
  );
};

export default WalletConnect;
```

#### 2.2.2 WalletStatus组件

```typescript
// components/wallet/WalletStatus.tsx
import React from 'react';
import { useWallet } from '@/hooks/useWallet';
import { Badge } from '@/components/ui/Badge';
import { Button } from '@/components/ui/Button';

const WalletStatus: React.FC = () => {
  const { connected, address, balance, network } = useWallet();

  if (!connected) {
    return (
      <div className="flex items-center space-x-2">
        <Badge variant="destructive">未连接</Badge>
      </div>
    );
  }

  return (
    <div className="flex items-center space-x-4">
      <div className="flex items-center space-x-2">
        <Badge variant="success">已连接</Badge>
        <span className="text-sm text-muted-foreground">{network}</span>
      </div>
      <div className="text-sm">
        <p className="font-medium">{address?.slice(0, 6)}...{address?.slice(-4)}</p>
        <p className="text-muted-foreground">{balance} USDC</p>
      </div>
    </div>
  );
};

export default WalletStatus;
```

### 2.3 彩票组件

#### 2.3.1 LotteryPhase组件

```typescript
// components/lottery/LotteryPhase.tsx
import React from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/Card';
import { Badge } from '@/components/ui/Badge';
import { useLottery } from '@/hooks/useLottery';
import { LotteryPhase as Phase } from '@/types/lottery';

const LotteryPhase: React.FC = () => {
  const { currentSession, phase, timeRemaining } = useLottery();

  const getPhaseInfo = (phase: Phase) => {
    switch (phase) {
      case Phase.COMMITMENT:
        return {
          title: '承诺阶段',
          description: '提交您的投注承诺',
          color: 'bg-blue-500',
          badge: '投注中'
        };
      case Phase.REVEAL:
        return {
          title: '揭秘阶段',
          description: '揭示您的随机数和幸运数字',
          color: 'bg-yellow-500',
          badge: '揭秘中'
        };
      case Phase.SETTLEMENT:
        return {
          title: '结算阶段',
          description: '计算中奖号码并分配奖金',
          color: 'bg-green-500',
          badge: '结算中'
        };
      default:
        return {
          title: '未知阶段',
          description: '系统状态异常',
          color: 'bg-gray-500',
          badge: '未知'
        };
    }
  };

  const phaseInfo = getPhaseInfo(phase);

  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center space-x-2">
          <span>当前阶段</span>
          <Badge variant="outline">{phaseInfo.badge}</Badge>
        </CardTitle>
        <CardDescription>{phaseInfo.description}</CardDescription>
      </CardHeader>
      <CardContent>
        <div className="space-y-4">
          <div className="flex items-center space-x-2">
            <div className={`w-3 h-3 rounded-full ${phaseInfo.color}`} />
            <span className="font-medium">{phaseInfo.title}</span>
          </div>
          {timeRemaining > 0 && (
            <div className="text-sm text-muted-foreground">
              剩余时间: {Math.floor(timeRemaining / 60)}分{timeRemaining % 60}秒
            </div>
          )}
          {currentSession && (
            <div className="text-sm">
              <p>会话ID: {currentSession.sessionId}</p>
              <p>总奖金池: {currentSession.totalPool} USDC</p>
              <p>参与者: {currentSession.participants.length}人</p>
            </div>
          )}
        </div>
      </CardContent>
    </Card>
  );
};

export default LotteryPhase;
```

#### 2.3.2 BetForm组件

```typescript
// components/lottery/BetForm.tsx
import React, { useState } from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/Card';
import { Button } from '@/components/ui/Button';
import { Input } from '@/components/ui/Input';
import { useLottery } from '@/hooks/useLottery';
import { useWallet } from '@/hooks/useWallet';

const BetForm: React.FC = () => {
  const { placeBet, loading } = useLottery();
  const { connected, balance } = useWallet();
  const [betAmount, setBetAmount] = useState('');
  const [luckyNumbers, setLuckyNumbers] = useState<number[]>([]);
  const [randomSeed, setRandomSeed] = useState('');

  const handleBetAmountChange = (value: string) => {
    const amount = parseInt(value);
    if (amount > 0 && amount <= balance) {
      setBetAmount(value);
      // 生成对应数量的幸运数字
      const numbers = Array.from({ length: amount }, () => 
        Math.floor(Math.random() * 1000)
      );
      setLuckyNumbers(numbers);
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!connected) return;

    try {
      await placeBet({
        betAmount: parseInt(betAmount),
        luckyNumbers,
        randomSeed
      });
    } catch (error) {
      console.error('Failed to place bet:', error);
    }
  };

  if (!connected) {
    return (
      <Card>
        <CardContent className="p-6">
          <p className="text-center text-muted-foreground">
            请先连接钱包
          </p>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle>投注</CardTitle>
        <CardDescription>选择投注金额和幸运数字</CardDescription>
      </CardHeader>
      <CardContent>
        <form onSubmit={handleSubmit} className="space-y-4">
          <Input
            label="投注金额"
            type="number"
            value={betAmount}
            onChange={(e) => handleBetAmountChange(e.target.value)}
            placeholder="输入投注金额"
            min="1"
            max={balance.toString()}
            helper={`可用余额: ${balance} USDC`}
          />
          
          {luckyNumbers.length > 0 && (
            <div>
              <label className="text-sm font-medium">幸运数字</label>
              <div className="mt-2 grid grid-cols-5 gap-2">
                {luckyNumbers.map((number, index) => (
                  <div
                    key={index}
                    className="p-2 text-center border rounded-md bg-muted"
                  >
                    {number}
                  </div>
                ))}
              </div>
            </div>
          )}

          <Input
            label="随机种子"
            value={randomSeed}
            onChange={(e) => setRandomSeed(e.target.value)}
            placeholder="输入随机种子"
            helper="用于生成承诺哈希的随机字符串"
          />

          <Button
            type="submit"
            disabled={loading || !betAmount || !randomSeed}
            className="w-full"
          >
            {loading ? '投注中...' : '确认投注'}
          </Button>
        </form>
      </CardContent>
    </Card>
  );
};

export default BetForm;
```

## 🔌 服务层设计

### 3.1 钱包服务

```typescript
// services/wallet/walletService.ts
import { WalletType } from '@/types/wallet';
import { AccountInfo, Balance } from '@/types/common';

export interface WalletService {
  connect(walletType: WalletType): Promise<void>;
  disconnect(): Promise<void>;
  getAccount(): Promise<AccountInfo>;
  getBalance(denom: string): Promise<Balance>;
  sendTransaction(tx: any): Promise<string>;
  signMessage(message: string): Promise<string>;
  on(event: string, callback: Function): void;
  off(event: string, callback: Function): void;
}

class WalletServiceImpl implements WalletService {
  private wallet: any = null;
  private listeners: Map<string, Function[]> = new Map();

  async connect(walletType: WalletType): Promise<void> {
    try {
      switch (walletType) {
        case WalletType.KEPLR:
          await this.connectKeplr();
          break;
        case WalletType.COSMOSTATION:
          await this.connectCosmostation();
          break;
        default:
          throw new Error('Unsupported wallet type');
      }
    } catch (error) {
      console.error('Failed to connect wallet:', error);
      throw error;
    }
  }

  private async connectKeplr(): Promise<void> {
    if (!window.keplr) {
      throw new Error('Keplr wallet not found');
    }

    try {
      await window.keplr.enable(process.env.REACT_APP_CHAIN_ID);
      this.wallet = window.keplr;
      this.emit('connected', { type: WalletType.KEPLR });
    } catch (error) {
      throw new Error('Failed to enable Keplr wallet');
    }
  }

  private async connectCosmostation(): Promise<void> {
    if (!window.cosmostation) {
      throw new Error('Cosmostation wallet not found');
    }

    try {
      await window.cosmostation.cosmos.request({
        method: 'cosmos_requestAccount',
        params: { chainName: process.env.REACT_APP_CHAIN_ID }
      });
      this.wallet = window.cosmostation;
      this.emit('connected', { type: WalletType.COSMOSTATION });
    } catch (error) {
      throw new Error('Failed to connect Cosmostation wallet');
    }
  }

  async disconnect(): Promise<void> {
    this.wallet = null;
    this.emit('disconnected', {});
  }

  async getAccount(): Promise<AccountInfo> {
    if (!this.wallet) {
      throw new Error('Wallet not connected');
    }

    try {
      const account = await this.wallet.getKey(process.env.REACT_APP_CHAIN_ID);
      return {
        address: account.bech32Address,
        pubKey: account.pubKey,
        algo: account.algo,
        isNanoLedger: account.isNanoLedger
      };
    } catch (error) {
      throw new Error('Failed to get account info');
    }
  }

  async getBalance(denom: string): Promise<Balance> {
    if (!this.wallet) {
      throw new Error('Wallet not connected');
    }

    try {
      const account = await this.getAccount();
      const response = await fetch(
        `${process.env.REACT_APP_RPC_URL}/cosmos/bank/v1beta1/balances/${account.address}`
      );
      const data = await response.json();
      
      const balance = data.balances.find((b: any) => b.denom === denom);
      return {
        denom,
        amount: balance ? balance.amount : '0'
      };
    } catch (error) {
      throw new Error('Failed to get balance');
    }
  }

  async sendTransaction(tx: any): Promise<string> {
    if (!this.wallet) {
      throw new Error('Wallet not connected');
    }

    try {
      const result = await this.wallet.signAndBroadcast(
        process.env.REACT_APP_CHAIN_ID,
        tx
      );
      return result.transactionHash;
    } catch (error) {
      throw new Error('Failed to send transaction');
    }
  }

  async signMessage(message: string): Promise<string> {
    if (!this.wallet) {
      throw new Error('Wallet not connected');
    }

    try {
      const result = await this.wallet.signMessage(
        process.env.REACT_APP_CHAIN_ID,
        message
      );
      return result.signature;
    } catch (error) {
      throw new Error('Failed to sign message');
    }
  }

  on(event: string, callback: Function): void {
    if (!this.listeners.has(event)) {
      this.listeners.set(event, []);
    }
    this.listeners.get(event)!.push(callback);
  }

  off(event: string, callback: Function): void {
    if (!this.listeners.has(event)) return;
    const callbacks = this.listeners.get(event)!;
    const index = callbacks.indexOf(callback);
    if (index > -1) {
      callbacks.splice(index, 1);
    }
  }

  private emit(event: string, data: any): void {
    if (!this.listeners.has(event)) return;
    this.listeners.get(event)!.forEach(callback => callback(data));
  }
}

export const walletService = new WalletServiceImpl();
```

### 3.2 合约服务

```typescript
// services/contract/contractService.ts
import { CosmWasmClient } from '@cosmjs/cosmwasm-stargate';
import { ContractAddress } from '@/types/contract';
import { LotterySession, ParticipantInfo, LotteryResult } from '@/types/lottery';

export interface ContractService {
  getCurrentSession(): Promise<LotterySession>;
  getParticipantInfo(address: string): Promise<ParticipantInfo>;
  getLotteryResult(sessionId: string): Promise<LotteryResult>;
  placeBet(commitmentHash: string): Promise<string>;
  revealRandom(luckyNumbers: number[], randomSeed: string): Promise<string>;
  settleLottery(): Promise<string>;
}

class ContractServiceImpl implements ContractService {
  private client: CosmWasmClient | null = null;
  private contractAddress: string;

  constructor() {
    this.contractAddress = process.env.REACT_APP_CONTRACT_ADDRESS || '';
  }

  private async getClient(): Promise<CosmWasmClient> {
    if (!this.client) {
      this.client = await CosmWasmClient.connect(process.env.REACT_APP_RPC_URL!);
    }
    return this.client;
  }

  async getCurrentSession(): Promise<LotterySession> {
    const client = await this.getClient();
    const query = { get_current_session: {} };
    
    try {
      const response = await client.queryContractSmart(this.contractAddress, query);
      return response.session;
    } catch (error) {
      throw new Error('Failed to get current session');
    }
  }

  async getParticipantInfo(address: string): Promise<ParticipantInfo> {
    const client = await this.getClient();
    const query = { get_participant_info: { participant: address } };
    
    try {
      const response = await client.queryContractSmart(this.contractAddress, query);
      return response.participant;
    } catch (error) {
      throw new Error('Failed to get participant info');
    }
  }

  async getLotteryResult(sessionId: string): Promise<LotteryResult> {
    const client = await this.getClient();
    const query = { get_lottery_result: { session_id: sessionId } };
    
    try {
      const response = await client.queryContractSmart(this.contractAddress, query);
      return response.result;
    } catch (error) {
      throw new Error('Failed to get lottery result');
    }
  }

  async placeBet(commitmentHash: string): Promise<string> {
    const client = await this.getClient();
    const msg = { place_bet: { commitment_hash: commitmentHash } };
    
    try {
      const result = await client.execute(
        process.env.REACT_APP_SENDER_ADDRESS!,
        this.contractAddress,
        msg,
        'auto'
      );
      return result.transactionHash;
    } catch (error) {
      throw new Error('Failed to place bet');
    }
  }

  async revealRandom(luckyNumbers: number[], randomSeed: string): Promise<string> {
    const client = await this.getClient();
    const msg = { 
      reveal_random: { 
        lucky_numbers: luckyNumbers,
        random_seed: randomSeed
      } 
    };
    
    try {
      const result = await client.execute(
        process.env.REACT_APP_SENDER_ADDRESS!,
        this.contractAddress,
        msg,
        'auto'
      );
      return result.transactionHash;
    } catch (error) {
      throw new Error('Failed to reveal random');
    }
  }

  async settleLottery(): Promise<string> {
    const client = await this.getClient();
    const msg = { settle_lottery: {} };
    
    try {
      const result = await client.execute(
        process.env.REACT_APP_SENDER_ADDRESS!,
        this.contractAddress,
        msg,
        'auto'
      );
      return result.transactionHash;
    } catch (error) {
      throw new Error('Failed to settle lottery');
    }
  }
}

export const contractService = new ContractServiceImpl();
```

## 🎣 自定义Hooks

### 4.1 useWallet Hook

```typescript
// hooks/useWallet.ts
import { useState, useEffect, useCallback } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { walletService } from '@/services/wallet/walletService';
import { WalletType } from '@/types/wallet';
import { AccountInfo, Balance } from '@/types/common';

export const useWallet = () => {
  const [connected, setConnected] = useState(false);
  const [address, setAddress] = useState<string | null>(null);
  const [balance, setBalance] = useState<Balance | null>(null);
  const [network, setNetwork] = useState<string>('');
  const queryClient = useQueryClient();

  // 查询账户信息
  const { data: accountInfo } = useQuery<AccountInfo>({
    queryKey: ['wallet', 'account'],
    queryFn: () => walletService.getAccount(),
    enabled: connected,
    refetchInterval: 30000
  });

  // 查询余额
  const { data: balanceInfo } = useQuery<Balance>({
    queryKey: ['wallet', 'balance'],
    queryFn: () => walletService.getBalance('uusd'),
    enabled: connected,
    refetchInterval: 10000
  });

  // 连接钱包
  const connectMutation = useMutation({
    mutationFn: (walletType: WalletType) => walletService.connect(walletType),
    onSuccess: () => {
      setConnected(true);
      queryClient.invalidateQueries({ queryKey: ['wallet'] });
    },
    onError: (error) => {
      console.error('Failed to connect wallet:', error);
    }
  });

  // 断开连接
  const disconnectMutation = useMutation({
    mutationFn: () => walletService.disconnect(),
    onSuccess: () => {
      setConnected(false);
      setAddress(null);
      setBalance(null);
      queryClient.clear();
    }
  });

  // 监听钱包事件
  useEffect(() => {
    const handleConnected = (data: any) => {
      setConnected(true);
      setNetwork(data.type);
    };

    const handleDisconnected = () => {
      setConnected(false);
      setAddress(null);
      setBalance(null);
    };

    walletService.on('connected', handleConnected);
    walletService.on('disconnected', handleDisconnected);

    return () => {
      walletService.off('connected', handleConnected);
      walletService.off('disconnected', handleDisconnected);
    };
  }, []);

  // 更新地址和余额
  useEffect(() => {
    if (accountInfo) {
      setAddress(accountInfo.address);
    }
  }, [accountInfo]);

  useEffect(() => {
    if (balanceInfo) {
      setBalance(balanceInfo);
    }
  }, [balanceInfo]);

  const connect = useCallback((walletType: WalletType) => {
    connectMutation.mutate(walletType);
  }, [connectMutation]);

  const disconnect = useCallback(() => {
    disconnectMutation.mutate();
  }, [disconnectMutation]);

  return {
    connected,
    address,
    balance,
    network,
    loading: connectMutation.isPending || disconnectMutation.isPending,
    connect,
    disconnect
  };
};
```

### 4.2 useLottery Hook

```typescript
// hooks/useLottery.ts
import { useState, useEffect } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { contractService } from '@/services/contract/contractService';
import { LotterySession, ParticipantInfo, LotteryResult } from '@/types/lottery';
import { LotteryPhase } from '@/types/lottery';

export const useLottery = () => {
  const [phase, setPhase] = useState<LotteryPhase>(LotteryPhase.COMMITMENT);
  const [timeRemaining, setTimeRemaining] = useState(0);
  const queryClient = useQueryClient();

  // 查询当前会话
  const { data: currentSession, isLoading: sessionLoading } = useQuery<LotterySession>({
    queryKey: ['lottery', 'currentSession'],
    queryFn: () => contractService.getCurrentSession(),
    refetchInterval: 5000
  });

  // 查询参与者信息
  const { data: participantInfo } = useQuery<ParticipantInfo>({
    queryKey: ['lottery', 'participantInfo'],
    queryFn: () => contractService.getParticipantInfo(''),
    enabled: false
  });

  // 投注操作
  const placeBetMutation = useMutation({
    mutationFn: (data: { betAmount: number; luckyNumbers: number[]; randomSeed: string }) => {
      // 生成承诺哈希
      const commitmentHash = generateCommitmentHash(data.luckyNumbers, data.randomSeed);
      return contractService.placeBet(commitmentHash);
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['lottery'] });
    }
  });

  // 揭秘操作
  const revealMutation = useMutation({
    mutationFn: (data: { luckyNumbers: number[]; randomSeed: string }) => {
      return contractService.revealRandom(data.luckyNumbers, data.randomSeed);
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['lottery'] });
    }
  });

  // 结算操作
  const settleMutation = useMutation({
    mutationFn: () => contractService.settleLottery(),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['lottery'] });
    }
  });

  // 计算阶段和剩余时间
  useEffect(() => {
    if (currentSession) {
      const now = Date.now();
      const sessionStart = currentSession.createdHeight * 1000; // 假设每个区块1秒
      const elapsed = now - sessionStart;
      const phaseMod = Math.floor(elapsed / 10000) % 3;
      
      switch (phaseMod) {
        case 0:
          setPhase(LotteryPhase.COMMITMENT);
          setTimeRemaining(6000 - (elapsed % 10000));
          break;
        case 1:
          setPhase(LotteryPhase.REVEAL);
          setTimeRemaining(3000 - (elapsed % 10000));
          break;
        case 2:
          setPhase(LotteryPhase.SETTLEMENT);
          setTimeRemaining(1000 - (elapsed % 10000));
          break;
      }
    }
  }, [currentSession]);

  const placeBet = (data: { betAmount: number; luckyNumbers: number[]; randomSeed: string }) => {
    placeBetMutation.mutate(data);
  };

  const revealRandom = (data: { luckyNumbers: number[]; randomSeed: string }) => {
    revealMutation.mutate(data);
  };

  const settleLottery = () => {
    settleMutation.mutate();
  };

  return {
    currentSession,
    phase,
    timeRemaining,
    participantInfo,
    loading: sessionLoading || placeBetMutation.isPending || revealMutation.isPending || settleMutation.isPending,
    placeBet,
    revealRandom,
    settleLottery
  };
};

// 生成承诺哈希
function generateCommitmentHash(luckyNumbers: number[], randomSeed: string): string {
  const data = JSON.stringify({ luckyNumbers, randomSeed });
  // 这里应该使用实际的哈希函数
  return btoa(data);
}
```

## 📊 状态管理

### 5.1 Zustand Store

```typescript
// stores/lotteryStore.ts
import { create } from 'zustand';
import { LotterySession, ParticipantInfo, LotteryResult } from '@/types/lottery';
import { LotteryPhase } from '@/types/lottery';

interface LotteryState {
  // 状态
  currentSession: LotterySession | null;
  phase: LotteryPhase;
  participantInfo: ParticipantInfo | null;
  history: LotteryResult[];
  
  // 操作
  setCurrentSession: (session: LotterySession | null) => void;
  setPhase: (phase: LotteryPhase) => void;
  setParticipantInfo: (info: ParticipantInfo | null) => void;
  addToHistory: (result: LotteryResult) => void;
  clearHistory: () => void;
}

export const useLotteryStore = create<LotteryState>((set) => ({
  // 初始状态
  currentSession: null,
  phase: LotteryPhase.COMMITMENT,
  participantInfo: null,
  history: [],
  
  // 操作
  setCurrentSession: (session) => set({ currentSession: session }),
  setPhase: (phase) => set({ phase }),
  setParticipantInfo: (info) => set({ participantInfo: info }),
  addToHistory: (result) => set((state) => ({ 
    history: [...state.history, result] 
  })),
  clearHistory: () => set({ history: [] })
}));
```

### 5.2 UI Store

```typescript
// stores/uiStore.ts
import { create } from 'zustand';

interface UIState {
  // 状态
  loading: boolean;
  error: string | null;
  theme: 'light' | 'dark';
  language: 'zh' | 'en';
  sidebarOpen: boolean;
  
  // 操作
  setLoading: (loading: boolean) => void;
  setError: (error: string | null) => void;
  setTheme: (theme: 'light' | 'dark') => void;
  setLanguage: (language: 'zh' | 'en') => void;
  setSidebarOpen: (open: boolean) => void;
  toggleSidebar: () => void;
}

export const useUIStore = create<UIState>((set) => ({
  // 初始状态
  loading: false,
  error: null,
  theme: 'light',
  language: 'zh',
  sidebarOpen: false,
  
  // 操作
  setLoading: (loading) => set({ loading }),
  setError: (error) => set({ error }),
  setTheme: (theme) => set({ theme }),
  setLanguage: (language) => set({ language }),
  setSidebarOpen: (open) => set({ sidebarOpen: open }),
  toggleSidebar: () => set((state) => ({ sidebarOpen: !state.sidebarOpen }))
}));
```

## 🛣️ 路由配置

### 6.1 路由定义

```typescript
// App.tsx
import React from 'react';
import { BrowserRouter as Router, Routes, Route } from 'react-router-dom';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { ThemeProvider } from '@/components/theme/ThemeProvider';
import { Layout } from '@/components/layout/Layout';
import { HomePage } from '@/pages/Home/HomePage';
import { BetPage } from '@/pages/Bet/BetPage';
import { RevealPage } from '@/pages/Reveal/RevealPage';
import { ResultPage } from '@/pages/Result/ResultPage';
import { HistoryPage } from '@/pages/History/HistoryPage';

const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      refetchOnWindowFocus: false,
      retry: 3,
      staleTime: 5 * 60 * 1000, // 5分钟
    },
  },
});

function App() {
  return (
    <QueryClientProvider client={queryClient}>
      <ThemeProvider>
        <Router>
          <Layout>
            <Routes>
              <Route path="/" element={<HomePage />} />
              <Route path="/bet" element={<BetPage />} />
              <Route path="/reveal" element={<RevealPage />} />
              <Route path="/result" element={<ResultPage />} />
              <Route path="/history" element={<HistoryPage />} />
            </Routes>
          </Layout>
        </Router>
      </ThemeProvider>
    </QueryClientProvider>
  );
}

export default App;
```

### 6.2 页面组件

```typescript
// pages/Home/HomePage.tsx
import React from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/Card';
import { WalletConnect } from '@/components/wallet/WalletConnect';
import { LotteryPhase } from '@/components/lottery/LotteryPhase';
import { useLottery } from '@/hooks/useLottery';

const HomePage: React.FC = () => {
  const { currentSession, phase } = useLottery();

  return (
    <div className="container mx-auto px-4 py-8">
      <div className="max-w-4xl mx-auto space-y-6">
        <div className="text-center space-y-2">
          <h1 className="text-4xl font-bold">DD 3D 彩票</h1>
          <p className="text-xl text-muted-foreground">
            去中心化3D彩票游戏
          </p>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <WalletConnect />
          <LotteryPhase />
        </div>

        {currentSession && (
          <Card>
            <CardHeader>
              <CardTitle>当前会话信息</CardTitle>
              <CardDescription>实时更新的彩票会话状态</CardDescription>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <p className="text-sm font-medium">会话ID</p>
                  <p className="text-sm text-muted-foreground">{currentSession.sessionId}</p>
                </div>
                <div>
                  <p className="text-sm font-medium">总奖金池</p>
                  <p className="text-sm text-muted-foreground">{currentSession.totalPool} USDC</p>
                </div>
                <div>
                  <p className="text-sm font-medium">参与者</p>
                  <p className="text-sm text-muted-foreground">{currentSession.participants.length}人</p>
                </div>
              </div>
            </CardContent>
          </Card>
        )}
      </div>
    </div>
  );
};

export default HomePage;
```

## 📝 变更记录

| 版本 | 日期 | 变更内容 | 变更人 |
|------|------|----------|--------|
| v1.0 | 2024-01-XX | 初始详细设计文档创建 | AI Assistant |

---

**注意**: 本文档详细描述了DD 3D彩票前端应用的实现细节，所有开发工作都必须基于此文档进行。
