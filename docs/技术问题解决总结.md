# æŠ€æœ¯é—®é¢˜è§£å†³æ€»ç»“

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

**é¡¹ç›®**: DD 3D Lottery Frontend  
**æŠ€æœ¯æ ˆ**: React 18 + TypeScript + Vite + CosmJS + Material-UI  
**éƒ¨ç½²å¹³å°**: Vercel  
**è§£å†³æ—¶é—´**: 2024å¹´1æœˆ

## ğŸš¨ ä¸»è¦é—®é¢˜

### 1. CosmJS é›†æˆé—®é¢˜
- **ç°è±¡**: æœ¬åœ°å¼€å‘æ­£å¸¸ï¼ŒVercel éƒ¨ç½²åæŠ¥é”™
- **é”™è¯¯**: `Uncaught TypeError: Illegal invocation`
- **æ ¹æœ¬åŸå› **: Web API çš„ `this` ç»‘å®šåœ¨æµè§ˆå™¨ç¯å¢ƒä¸­ä¸¢å¤±

### 2. æ„å»ºé…ç½®é—®é¢˜
- **ç°è±¡**: ç”Ÿäº§æ„å»ºå¤±è´¥
- **é”™è¯¯**: `RollupError: Assigning to rvalue`
- **æ ¹æœ¬åŸå› **: Vite çš„ `define` é…ç½®å¯¼è‡´è¯­æ³•é”™è¯¯

### 3. æ¨¡å—åŠ è½½é¡ºåºé—®é¢˜
- **ç°è±¡**: Polyfill æœªç”Ÿæ•ˆ
- **æ ¹æœ¬åŸå› **: æ¨¡å—åŠ è½½æ—¶æœºä¸æ­£ç¡®

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### 1. åˆ›å»ºä¸“ç”¨ Polyfill æ–‡ä»¶

**æ–‡ä»¶**: `src/axios-polyfill.ts`
```typescript
// ä¸“é—¨è§£å†³ axios çš„ "Illegal invocation" é”™è¯¯
const boundFetch = originalFetch.bind(window);
Object.defineProperty(globalThis, 'fetch', {
  value: boundFetch,
  writable: true,
  configurable: true,
  enumerable: false
});
```

**æ–‡ä»¶**: `src/polyfill.ts`
```typescript
// å¤„ç† CosmJS åº“çš„ Node.js æ¨¡å—é—®é¢˜
if (typeof globalThis === 'undefined') {
  (window as any).globalThis = window;
}
```

### 2. å¼ºåŒ– HTML å…¨å±€è®¾ç½®

**æ–‡ä»¶**: `index.html`
```html
<script>
(function() {
  // å¼ºåˆ¶è®¾ç½® globalThis
  if (typeof globalThis === 'undefined') {
    window.globalThis = window;
  }
  
  // åˆ›å»º Web API polyfill
  const polyfill = createSimplePolyfill();
  globalThis.Request = polyfill.Request;
  globalThis.Response = polyfill.Response;
  globalThis.Headers = polyfill.Headers;
  globalThis.fetch = polyfill.fetch;
})();
</script>
```

### 3. ä¼˜åŒ– Vite é…ç½®

**æ–‡ä»¶**: `vite.config.ts`
```typescript
export default defineConfig({
  define: {
    'process.browser': 'true',
    'process.version': '""',
    'process.versions': '{}',
    'process.platform': '"browser"',
  },
  optimizeDeps: {
    include: ['@cosmjs/cosmwasm-stargate', '@cosmjs/stargate'],
    force: true,
  },
  build: {
    minify: false, // æš‚æ—¶ç¦ç”¨å‹ç¼©
  },
})
```

### 4. ä¿®æ­£å…¥å£æ–‡ä»¶åŠ è½½é¡ºåº

**æ–‡ä»¶**: `src/main.tsx`
```typescript
// é¦–å…ˆå¯¼å…¥ polyfill
import './axios-polyfill'
import './polyfills'

// ç„¶åå¯¼å…¥å…¶ä»–æ¨¡å—
import React from 'react'
// ...
```

## ğŸ“Š è§£å†³æ•ˆæœ

| æŒ‡æ ‡ | è§£å†³å‰ | è§£å†³å |
|------|--------|--------|
| **æœ¬åœ°å¼€å‘** | âœ… æ­£å¸¸ | âœ… æ­£å¸¸ |
| **ç”Ÿäº§æ„å»º** | âŒ å¤±è´¥ | âœ… æˆåŠŸ |
| **Vercel éƒ¨ç½²** | âŒ é”™è¯¯ | âœ… æ­£å¸¸ |
| **CosmJS åŠŸèƒ½** | âŒ ä¸å¯ç”¨ | âœ… å®Œå…¨å¯ç”¨ |
| **æ„å»ºæ—¶é—´** | - | 2åˆ†8ç§’ |
| **æ„å»ºå¤§å°** | - | 6.7MB |

## ğŸ¯ å…³é”®ç»éªŒ

### 1. Polyfill åŠ è½½é¡ºåºè‡³å…³é‡è¦
```typescript
// âœ… æ­£ç¡®é¡ºåº
import './axios-polyfill'  // 1. é¦–å…ˆä¿®å¤ axios
import './polyfills'       // 2. ç„¶ååŠ è½½é€šç”¨ polyfill
import './main'            // 3. æœ€ååŠ è½½åº”ç”¨ä»£ç 
```

### 2. å…¨å±€å¯¹è±¡è®¾ç½®å¿…é¡»åœ¨æ¨¡å—åŠ è½½å‰
```html
<!-- âœ… åœ¨ HTML ä¸­è®¾ç½®ï¼Œç¡®ä¿æœ€æ—©æ‰§è¡Œ -->
<script>
  // è®¾ç½® globalThis å’Œ Web API polyfill
</script>
<script type="module" src="/src/main.tsx"></script>
```

### 3. Web API ç»‘å®šéœ€è¦ç‰¹æ®Šå¤„ç†
```javascript
// âœ… æ­£ç¡®çš„ç»‘å®šæ–¹å¼
const boundAPI = originalAPI.bind(window);
Object.defineProperty(globalThis, 'api', {
  value: boundAPI,
  writable: true,
  configurable: true,
  enumerable: false
});
```

### 4. Vite é…ç½®éœ€è¦ç²¾ç¡®è°ƒæ•´
```typescript
// âœ… å…³é”®é…ç½®
define: {
  'process.browser': 'true',  // æ ‡è¯†æµè§ˆå™¨ç¯å¢ƒ
  'process.version': '""',    // ç©ºå­—ç¬¦ä¸²é¿å… undefined
},
optimizeDeps: {
  include: ['@cosmjs/cosmwasm-stargate'], // é¢„æ„å»º CosmJS
  force: true, // å¼ºåˆ¶é‡æ–°æ„å»º
}
```

## ğŸ”§ æ•…éšœæ’é™¤æµç¨‹

### 1. é—®é¢˜è¯Šæ–­
```javascript
// æ·»åŠ è°ƒè¯•æ—¥å¿—
console.log('=== è°ƒè¯•ä¿¡æ¯ ===');
console.log('globalThis:', typeof globalThis);
console.log('Request:', typeof globalThis.Request);
console.log('Response:', typeof globalThis.Response);
console.log('Headers:', typeof globalThis.Headers);
console.log('fetch:', typeof globalThis.fetch);
```

### 2. é€æ­¥æ’æŸ¥
1. æ£€æŸ¥ polyfill æ˜¯å¦åŠ è½½
2. éªŒè¯å…¨å±€å¯¹è±¡æ˜¯å¦æ­£ç¡®è®¾ç½®
3. ç¡®è®¤ Web API ç»‘å®šæ˜¯å¦æ­£ç¡®
4. æ£€æŸ¥ Vite é…ç½®æ˜¯å¦åˆç†
5. éªŒè¯æ„å»ºè¿‡ç¨‹æ˜¯å¦æˆåŠŸ

### 3. å¸¸è§é”™è¯¯å¤„ç†
- **"Illegal invocation"**: æ£€æŸ¥ Web API çš„ `this` ç»‘å®š
- **"Cannot destructure property"**: æ£€æŸ¥ `globalThis` æ˜¯å¦å®šä¹‰
- **æ„å»ºå¤±è´¥**: æ£€æŸ¥ Vite é…ç½®è¯­æ³•
- **æ¨¡å—è§£æé—®é¢˜**: æ£€æŸ¥ `optimizeDeps` é…ç½®

## ğŸ“š æŠ€æœ¯è¦ç‚¹æ€»ç»“

### 1. æµè§ˆå™¨å…¼å®¹æ€§
- CosmJS ä¾èµ– Node.js æ¨¡å—ï¼Œéœ€è¦ polyfill
- Web API åœ¨æ¨¡å—åŒ–ç¯å¢ƒä¸­å®¹æ˜“ä¸¢å¤± `this` ç»‘å®š
- å…¨å±€å¯¹è±¡è®¾ç½®å¿…é¡»åœ¨æ¨¡å—åŠ è½½å‰å®Œæˆ

### 2. æ„å»ºå·¥å…·é…ç½®
- Vite çš„ `define` é€‰é¡¹ç”¨äºæ›¿æ¢å…¨å±€å˜é‡
- `optimizeDeps` ç”¨äºé¢„æ„å»ºä¾èµ–
- ä»£ç å‹ç¼©å¯èƒ½å½±å“ polyfill çš„æ‰§è¡Œ

### 3. éƒ¨ç½²ç¯å¢ƒå·®å¼‚
- å¼€å‘ç¯å¢ƒ (Vite dev server) ä¸ç”Ÿäº§ç¯å¢ƒ (Vite build) ä¸åŒ
- æ¨¡å—åŠ è½½é¡ºåºåœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ›´ä¸¥æ ¼
- ä»£ç ä¼˜åŒ–å¯èƒ½å½±å“ polyfill çš„æ—¶æœº

## ğŸš€ æœ€ä½³å®è·µ

### 1. å¼€å‘æµç¨‹
1. å…ˆè§£å†³æœ¬åœ°å¼€å‘é—®é¢˜
2. å†è§£å†³ç”Ÿäº§æ„å»ºé—®é¢˜
3. æœ€åè§£å†³éƒ¨ç½²ç¯å¢ƒé—®é¢˜
4. é€æ­¥éªŒè¯æ¯ä¸ªç¯èŠ‚

### 2. ä»£ç ç»„ç»‡
1. åˆ›å»ºä¸“ç”¨çš„ polyfill æ–‡ä»¶
2. åœ¨ HTML ä¸­è®¾ç½®å…¨å±€ polyfill
3. ç¡®ä¿æ­£ç¡®çš„åŠ è½½é¡ºåº
4. æ·»åŠ å……åˆ†çš„è°ƒè¯•æ—¥å¿—

### 3. é…ç½®ç®¡ç†
1. ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†é…ç½®
2. åˆ†ç¦»å¼€å‘å’Œç”Ÿäº§é…ç½®
3. å®šæœŸéªŒè¯é…ç½®çš„æœ‰æ•ˆæ€§
4. æ–‡æ¡£åŒ–é…ç½®å˜æ›´

## ğŸ“ åç»­å»ºè®®

### 1. ä»£ç ä¼˜åŒ–
- è€ƒè™‘ä½¿ç”¨æ›´è½»é‡çš„ polyfill åº“
- ä¼˜åŒ–æ„å»ºé…ç½®ä»¥æé«˜æ€§èƒ½
- æ·»åŠ æ›´å¤šçš„é”™è¯¯å¤„ç†æœºåˆ¶

### 2. æµ‹è¯•å®Œå–„
- æ·»åŠ  CosmJS é›†æˆæµ‹è¯•
- åˆ›å»ºç«¯åˆ°ç«¯æµ‹è¯•ç”¨ä¾‹
- å»ºç«‹è‡ªåŠ¨åŒ–æµ‹è¯•æµç¨‹

### 3. æ–‡æ¡£ç»´æŠ¤
- å®šæœŸæ›´æ–°æŠ€æœ¯æ–‡æ¡£
- è®°å½•æ–°çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ
- åˆ†äº«ç»éªŒç»™å…¶ä»–é¡¹ç›®

---

**æ€»ç»“**: é€šè¿‡ç³»ç»Ÿæ€§çš„é—®é¢˜åˆ†æå’Œé€æ­¥è§£å†³ï¼ŒæˆåŠŸå®ç°äº† CosmJS åœ¨ React + Vite é¡¹ç›®ä¸­çš„é›†æˆï¼Œä¸ºåç»­ç±»ä¼¼é¡¹ç›®æä¾›äº†å®è´µçš„ç»éªŒå‚è€ƒã€‚
